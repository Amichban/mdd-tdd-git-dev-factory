name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-issue-reference:
    name: Check Issue Reference
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title or body for issue reference
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || '';
            const branch = pr.head.ref;

            // Check for issue reference patterns
            const issuePattern = /#\d+|closes #\d+|fixes #\d+|resolves #\d+/i;
            const branchPattern = /^(issue|feature|fix|bugfix)-(\d+)/i;

            const hasIssueInTitle = issuePattern.test(title);
            const hasIssueInBody = issuePattern.test(body);
            const hasIssueInBranch = branchPattern.test(branch);

            if (!hasIssueInTitle && !hasIssueInBody && !hasIssueInBranch) {
              core.setFailed(
                'PR must reference a GitHub issue. ' +
                'Include #<issue-number> in the PR title or body, ' +
                'or use a branch name like issue-123-description.'
              );
            }

            console.log('Issue reference found - PR check passed');

  check-specs-changed:
    name: Check Spec Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            specs/**/*.json

      - name: Validate changed specs
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Specs changed: ${{ steps.changed-files.outputs.all_changed_files }}"

          # Install jsonschema
          pip install jsonschema

          # Validate each changed spec
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Validating $file..."
            python -c "
          import json
          from pathlib import Path
          from jsonschema import validate

          spec_file = Path('$file')
          schema_name = spec_file.stem.replace('.schema', '')
          schema_file = spec_file.parent / 'schema' / f'{schema_name}.schema.json'

          if schema_file.exists():
              with open(spec_file) as f:
                  data = json.load(f)
              with open(schema_file) as f:
                  schema = json.load(f)
              validate(data, schema)
              print(f'  ✓ {spec_file} is valid')
          else:
              print(f'  ⚠ No schema found for {spec_file}')
          "
          done

  check-generated-code:
    name: Check Generated Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate code
        run: |
          python generators/generate_models.py
          python generators/generate_routes.py

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "Generated code is out of sync with specs!"
            echo "Please run generators and commit the changes."
            git status
            exit 1
          fi
          echo "Generated code is in sync with specs"
