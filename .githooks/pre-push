#!/bin/bash
#
# Pre-push hook: Enforces GitHub issue linking
#
# Checks:
# 1. Branch name follows convention (feat/issue-123-description)
# 2. GitHub issue exists and is open
# 3. Commits reference the issue
#
# Install: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get current branch
BRANCH=$(git branch --show-current)

# Skip checks for main/master/develop
if [[ "$BRANCH" == "main" || "$BRANCH" == "master" || "$BRANCH" == "develop" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Pushing directly to $BRANCH - ensure you have approval${NC}"
    exit 0
fi

# ============================================
# Check 1: Branch naming convention
# ============================================
echo -n "  Checking branch name convention... "

# Expected patterns:
# feat/issue-123-description
# fix/issue-456-description
# refactor/issue-789-description
BRANCH_PATTERN="^(feat|fix|refactor|docs|test|chore)/issue-[0-9]+-[a-z0-9-]+$"

if [[ $BRANCH =~ $BRANCH_PATTERN ]]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo -e "    ${RED}‚ùå Branch name '$BRANCH' doesn't follow convention${NC}"
    echo -e "    ${YELLOW}‚Üí Expected: feat/issue-123-description${NC}"
    echo -e "    ${YELLOW}‚Üí Or: fix/issue-456-bug-fix${NC}"
    echo ""
    echo -e "    ${YELLOW}To rename your branch:${NC}"
    echo -e "    git branch -m $BRANCH feat/issue-XXX-your-description"
    exit 1
fi

# ============================================
# Check 2: Extract issue number
# ============================================
ISSUE_NUMBER=$(echo "$BRANCH" | grep -oE 'issue-[0-9]+' | grep -oE '[0-9]+')

if [ -z "$ISSUE_NUMBER" ]; then
    echo -e "${RED}‚ùå Could not extract issue number from branch name${NC}"
    exit 1
fi

echo -n "  Verifying GitHub issue #$ISSUE_NUMBER exists... "

# ============================================
# Check 3: Verify issue exists (if gh CLI available)
# ============================================
if command -v gh &> /dev/null; then
    # Check if authenticated
    if gh auth status &> /dev/null; then
        # Try to get the issue
        if gh issue view "$ISSUE_NUMBER" --json state,title > /tmp/gh_issue.json 2>&1; then
            ISSUE_STATE=$(cat /tmp/gh_issue.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('state', 'UNKNOWN'))" 2>/dev/null || echo "UNKNOWN")
            ISSUE_TITLE=$(cat /tmp/gh_issue.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('title', 'Unknown'))" 2>/dev/null || echo "Unknown")

            if [ "$ISSUE_STATE" == "OPEN" ]; then
                echo -e "${GREEN}OK${NC}"
                echo -e "    üìã Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
            elif [ "$ISSUE_STATE" == "CLOSED" ]; then
                echo -e "${YELLOW}WARNING${NC}"
                echo -e "    ${YELLOW}‚ö†Ô∏è  Issue #$ISSUE_NUMBER is closed${NC}"
                echo -e "    Consider reopening if work is ongoing"
            else
                echo -e "${YELLOW}UNKNOWN${NC}"
            fi
        else
            echo -e "${RED}FAILED${NC}"
            echo -e "    ${RED}‚ùå Issue #$ISSUE_NUMBER not found${NC}"
            echo -e "    ${YELLOW}‚Üí Create the issue first: gh issue create${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}SKIPPED${NC} (gh not authenticated)"
        echo -e "    ${YELLOW}‚Üí Run 'gh auth login' to enable issue verification${NC}"
    fi
else
    echo -e "${YELLOW}SKIPPED${NC} (gh CLI not installed)"
fi

# ============================================
# Check 4: Verify commits reference issue
# ============================================
echo -n "  Checking commits reference issue... "

# Get commits that will be pushed
REMOTE_REF=$(git rev-parse @{u} 2>/dev/null || echo "")
if [ -n "$REMOTE_REF" ]; then
    COMMITS=$(git log $REMOTE_REF..HEAD --oneline)
else
    # New branch, check all commits
    COMMITS=$(git log origin/main..HEAD --oneline 2>/dev/null || git log --oneline -10)
fi

# Check if any commit mentions the issue
if echo "$COMMITS" | grep -qE "(#$ISSUE_NUMBER|issue-$ISSUE_NUMBER|Issue $ISSUE_NUMBER)"; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "    ${YELLOW}‚ö†Ô∏è  No commits reference issue #$ISSUE_NUMBER${NC}"
    echo -e "    ${YELLOW}‚Üí Consider amending: git commit --amend -m \"feat: ... (#$ISSUE_NUMBER)\"${NC}"
    # Don't fail, just warn
fi

# ============================================
# Check 5: Ensure tests pass before push
# ============================================
echo -n "  Running full test suite... "

if [ -d "tests" ] && command -v pytest &> /dev/null; then
    if pytest tests/ -q --tb=short > /tmp/pytest_push.txt 2>&1; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo "    ‚ùå Tests must pass before pushing:"
        tail -20 /tmp/pytest_push.txt
        exit 1
    fi
else
    echo -e "${YELLOW}SKIPPED${NC}"
fi

# ============================================
# Final result
# ============================================
echo ""
echo -e "${GREEN}‚úÖ Pre-push checks passed! Pushing to origin...${NC}"
exit 0
