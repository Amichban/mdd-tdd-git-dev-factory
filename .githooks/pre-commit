#!/bin/bash
#
# Pre-commit hook: Enforces the model-driven workflow
#
# Checks:
# 1. JSON specs are valid against schema
# 2. Generated code matches specs (no manual edits to generated files)
# 3. Tests pass
# 4. Coverage meets threshold
#
# Install: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# ============================================
# Check 1: Validate JSON specs against schema
# ============================================
echo -n "  Validating JSON specs... "

if [ -d "specs" ]; then
    # Check if jsonschema is installed
    if command -v python3 &> /dev/null; then
        python3 << 'EOF'
import json
import sys
from pathlib import Path

try:
    from jsonschema import validate, ValidationError
except ImportError:
    print("‚ö†Ô∏è  jsonschema not installed, skipping validation")
    sys.exit(0)

specs_dir = Path("specs")
schema_dir = specs_dir / "schema"

validations = [
    ("entities.json", "entity.schema.json"),
    ("algorithms.json", "algorithm.schema.json"),
    ("workflows.json", "workflow.schema.json"),
    ("roles.json", "roles.schema.json"),
]

errors = []
for spec_file, schema_file in validations:
    spec_path = specs_dir / spec_file
    schema_path = schema_dir / schema_file

    if spec_path.exists() and schema_path.exists():
        try:
            with open(spec_path) as f:
                spec = json.load(f)
            with open(schema_path) as f:
                schema = json.load(f)
            validate(instance=spec, schema=schema)
        except ValidationError as e:
            errors.append(f"{spec_file}: {e.message}")
        except json.JSONDecodeError as e:
            errors.append(f"{spec_file}: Invalid JSON - {e}")

if errors:
    print("FAILED")
    for error in errors:
        print(f"    ‚ùå {error}")
    sys.exit(1)
else:
    print("OK")
EOF
        if [ $? -ne 0 ]; then
            FAILED=1
        fi
    else
        echo -e "${YELLOW}SKIPPED${NC} (python3 not found)"
    fi
else
    echo -e "${YELLOW}SKIPPED${NC} (no specs directory)"
fi

# ============================================
# Check 2: Verify generated code not manually edited
# ============================================
echo -n "  Checking for manual edits to generated code... "

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Generated directories that should not be manually edited
GENERATED_PATTERNS=(
    "src/domain/models/"
    "src/app/api/generated/"
)

MANUAL_EDITS=()
for file in $STAGED_FILES; do
    for pattern in "${GENERATED_PATTERNS[@]}"; do
        if [[ "$file" == $pattern* ]]; then
            # Check if corresponding spec was also modified
            SPEC_MODIFIED=0
            if git diff --cached --name-only | grep -q "specs/"; then
                SPEC_MODIFIED=1
            fi

            if [ $SPEC_MODIFIED -eq 0 ]; then
                MANUAL_EDITS+=("$file")
            fi
        fi
    done
done

if [ ${#MANUAL_EDITS[@]} -gt 0 ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "    ${RED}‚ùå Manual edits detected in generated files:${NC}"
    for file in "${MANUAL_EDITS[@]}"; do
        echo "       - $file"
    done
    echo -e "    ${YELLOW}‚Üí Edit specs/ and run /generate instead${NC}"
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 3: Run tests
# ============================================
echo -n "  Running tests... "

if [ -d "tests" ] && command -v pytest &> /dev/null; then
    # Run tests quietly, only show output on failure
    if pytest tests/ -q --tb=no > /tmp/pytest_output.txt 2>&1; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo "    ‚ùå Tests failed:"
        cat /tmp/pytest_output.txt | head -20
        FAILED=1
    fi
elif [ -d "tests" ]; then
    echo -e "${YELLOW}SKIPPED${NC} (pytest not found)"
else
    echo -e "${YELLOW}SKIPPED${NC} (no tests directory)"
fi

# ============================================
# Check 4: Lint TypeScript/JavaScript
# ============================================
echo -n "  Linting code... "

if [ -f "package.json" ] && command -v npx &> /dev/null; then
    # Check if eslint is configured
    if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.mjs" ]; then
        # Only lint staged files
        STAGED_JS=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)
        if [ -n "$STAGED_JS" ]; then
            if npx eslint $STAGED_JS --quiet > /tmp/eslint_output.txt 2>&1; then
                echo -e "${GREEN}OK${NC}"
            else
                echo -e "${RED}FAILED${NC}"
                cat /tmp/eslint_output.txt | head -20
                FAILED=1
            fi
        else
            echo -e "${GREEN}OK${NC} (no JS/TS files staged)"
        fi
    else
        echo -e "${YELLOW}SKIPPED${NC} (no eslint config)"
    fi
else
    echo -e "${YELLOW}SKIPPED${NC} (no package.json)"
fi

# ============================================
# Check 5: Python type checking
# ============================================
echo -n "  Type checking Python... "

STAGED_PY=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)
if [ -n "$STAGED_PY" ] && command -v mypy &> /dev/null; then
    if mypy $STAGED_PY --ignore-missing-imports --no-error-summary > /tmp/mypy_output.txt 2>&1; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}WARNINGS${NC}"
        # Don't fail on mypy warnings, just show them
        cat /tmp/mypy_output.txt | head -10
    fi
elif [ -n "$STAGED_PY" ]; then
    echo -e "${YELLOW}SKIPPED${NC} (mypy not found)"
else
    echo -e "${GREEN}OK${NC} (no Python files staged)"
fi

# ============================================
# Final result
# ============================================
echo ""
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed. Please fix the issues above.${NC}"
    echo -e "${YELLOW}   Use 'git commit --no-verify' to bypass (not recommended)${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    exit 0
fi
