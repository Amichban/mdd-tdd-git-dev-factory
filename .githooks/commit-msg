#!/bin/bash
#
# Commit-msg hook: Enforces issue reference in commit messages
#
# Ensures every commit is traceable to a GitHub issue
#
# Install: git config core.hooksPath .githooks

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get current branch
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# Check if branch already references an issue
ISSUE_BRANCH_PATTERN="^(issue|feature|fix|bugfix)-([0-9]+)"
if [[ "$BRANCH_NAME" =~ $ISSUE_BRANCH_PATTERN ]]; then
    # Branch has issue reference, commit message doesn't need one
    exit 0
fi

# Check if commit message contains issue reference
ISSUE_PATTERN="#[0-9]+"
if [[ "$COMMIT_MSG" =~ $ISSUE_PATTERN ]]; then
    echo -e "${GREEN}✅ Commit message references issue${NC}"
    exit 0
fi

# No issue reference found
echo -e "${RED}❌ Commit message must reference a GitHub issue${NC}"
echo ""
echo "Your commit message:"
echo "  $COMMIT_MSG"
echo ""
echo "Add an issue reference using one of these formats:"
echo "  - 'Add feature #123'"
echo "  - 'Fix bug, closes #456'"
echo "  - 'Update docs (refs #789)'"
echo ""
echo -e "${YELLOW}No issue yet? Create one first:${NC}"
echo "  gh issue create --title 'Your feature' --body 'Description'"
echo ""
echo "Or create branch from issue:"
echo "  git checkout -b issue-123-description"
echo ""
exit 1
